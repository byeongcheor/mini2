<%@ page language="java" contentType="text/html; charset=UTF-8"
   pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"  %>
<script src="https://kit.fontawesome.com/5736c47827.js" crossorigin="anonymous"></script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b45e962e5c780aecefa8a8cae0f46328&autoload=false"></script>
<link rel="stylesheet" href="/mini/css/food.css" type="text/css"/>
<title>${restView.store_name} : ìŒì‹ | ìƒì„¸ ì •ë³´</title>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star');
    const selectedRatingInput = document.getElementById('selectedRating');
    const reviewForm = document.getElementById('reviewForm');

 // ë³„ì  í´ë¦­ ì´ë²¤íŠ¸
    $('.rating .star').on('click', function() {
        var ratingValue = $(this).data('value');
        $('#selectedRating').val(ratingValue);  // ì„ íƒí•œ ë³„ì  ê°’ì„ hidden inputì— ì €ì¥

        // ëª¨ë“  ë³„ì  ì„ íƒ í•´ì œ í›„ ì„ íƒí•œ ë³„ì ê¹Œì§€ ì„ íƒ í‘œì‹œ
        $('.rating .star').removeClass('selected');
        $(this).addClass('selected');
        $(this).prevAll().addClass('selected');  // ì´ì „ ë³„ë“¤ì—ë„ ì„ íƒ í‘œì‹œ
    });
    
    

    // ë¦¬ë·° ì œì¶œ ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ì œì¶œ
    const reviewSubmitButton = document.querySelector('.review_submit');
    if (reviewSubmitButton) {
        reviewSubmitButton.addEventListener('click', function(event) {
            if (selectedRatingInput.value === '') {
                alert('ë³„ì ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                event.preventDefault(); // ë³„ì ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ í¼ ì œì¶œ ë°©ì§€
            }
        });
    }

    $(document).on('click', '.like-icon', function() {
        var rest_code = $(this).data('rest-code');
        var userid = '${logId}';  // ì‚¬ìš©ì ID (ì„œë²„ì—ì„œ ë Œë”ë§ëœ ê°’)

        if (!userid) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        $.ajax({
            url: `/mini/rest/restView/${rest_code}/Togglelikes`,
            type: 'POST',
            data: { rest_code: rest_code, userid: userid },
            success: function(response) {
                if (response.error) {
                    alert(response.error);
                } else {
                    var icon = $(`.like-icon[data-rest-code="${rest_code}"]`);
                    icon.text(response.likes ? 'â™¥(ì¡°ì•„ìš©)' : 'â™¡(ì¢‹ì•„ìš”)'); // ì¢‹ì•„ìš” ìƒíƒœ ì—…ë°ì´íŠ¸
                    
                    // ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½
                    if (response.likes) {
                        icon.css('color', 'red');  // ì¢‹ì•„ìš” ëˆŒë €ì„ ë•Œ ë¹¨ê°„ìƒ‰
                    } else {
                        icon.css('color', 'black');  // ì¢‹ì•„ìš” ì·¨ì†Œ ì‹œ ê²€ì •ìƒ‰
                    }
                    
                    $('#like-count').text(response.likeCount); // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
                }
            },
            error: function(error) {
                console.error('ì—ëŸ¬ ë°œìƒ:', error);
            }
        });
    });

    $(document).ready(function() {
        var userId = '${logId}';  // ì‚¬ìš©ì ID (ì„œë²„ì—ì„œ ë Œë”ë§ëœ ê°’)

        if (userId) {
            $.ajax({
                url: `/mini/rest/restView/${restView.rest_code}/mylikes`,
                type: 'GET',
                data: { userId: userId },
                success: function(result) {
                    if (result.error) {
                        console.error(result.error);
                    } else {
                        var likedRestCodes = result.likes;
                        $('.like-icon').each(function() {
                            var restCode = $(this).data('rest-code');
                            var isLiked = likedRestCodes.includes(restCode);

                            $(this).text(isLiked ? 'â™¥(ì¡°ì•„ìš”)' : 'â™¡(ì¢‹ì•„ìš”)');
                            
                            // ì´ˆê¸° ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒ ì„¤ì •
                            $(this).css('color', isLiked ? 'red' : 'black');
                        });
                    }
                },
                error: function(error) {
                    console.error('ì—ëŸ¬ ë°œìƒ:', error);
                }
            });
        }
    });


    // ë¦¬ë·° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function reviewList() {
        $.ajax({
            url: `/mini/rest/restView/${restView.rest_code}/reviewList`,
            type: 'GET',
            success: function(result) {
                var reviewTag = "";
                $(result).each(function(idx, rVO) {
                    reviewTag += `
                        <div class="review-item">
                            <div class="review-content">
                                <b>`+rVO.userid+`</b> (`+rVO.writedate+`)
                                <p>`+rVO.contents+`</p>`;

                                var logId = '${logId}'
                                if (rVO.userid === logId || logId === 'root' ) {
                        reviewTag += `
                            <input type='button' value='ìˆ˜ì •' class='btn btn-outline-secondary' data-review-no='`+rVO.review_no+`'/>
                            <input type='button' value='ì‚­ì œ' class='btn btn-outline-danger' data-review-no='`+rVO.review_no+`'/>`;
                        reviewTag += `
                            </div>
                            <div class='edit-form' data-review-no='`+rVO.review_no+`' style='display:none;'>
                            <form class="edit-review-form" method="post" action="/mini/rest/restView/${restView.rest_code}/edit">
                                    <textarea name='contents' id='contents`+rVO.review_no+`' style="width: 500px;">`+rVO.contents+`</textarea>
                                    <input type='hidden' name='review_no' value='`+rVO.review_no+`'/>
                                    <input type='submit' value='ëŒ“ê¸€ìˆ˜ì •í•˜ê¸°'/>
                                </form>
                            </div><hr/>`;
                    } else {
                        reviewTag += `</div><hr/>`;
                    }
                });
                $(".reviewList").html(reviewTag);
            },
            error: function(error) {
                console.log(error.responseText);
            }
        });
    }

    // ë¦¬ë·° ë“±ë¡
   $('#reviewForm').on('submit', function(e) {
    e.preventDefault();  // í¼ì˜ ê¸°ë³¸ ì œì¶œ ë°©ì§€
    
    $.ajax({
        type: 'POST',
        url: `/mini/rest/restView/${restView.rest_code}/ReviewOk`,
        data: $(this).serialize(),  // í¼ ë°ì´í„°ë¥¼ ì§ë ¬í™”í•˜ì—¬ ì „ì†¡
        success: function(result) {
            if (result === '1') {
                alert('ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                $('#contents').val('');
                $('#selectedRating').val('');  // ìˆ¨ê²¨ì§„ ë³„ì  ê°’ ì´ˆê¸°í™”
                $('.rating .star').removeClass('selected');  // ëª¨ë“  ë³„ì  ì„ íƒ í•´ì œ
                reviewList();  // ë¦¬ë·° ëª©ë¡ ê°±ì‹ 
            } else {
                alert('ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.');
            }
        },
        error: function(error) {
            console.log(error.responseText);
        }
    });
});

// ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ˜ì • í¼ í‘œì‹œ
   $(document).on('click', '.btn-outline-secondary', function() {

       $('.edit-form').hide();

       var review_no = $(this).data('review-no');

       $(`.edit-form[data-review-no="` + review_no + `"]`).show();
   });

   // ë¦¬ë·° ìˆ˜ì •
   $(document).on('submit', '.edit-review-form', function(event) {
       event.preventDefault();  


       var params = $(this).serialize();


       $.ajax({
           type: 'POST',
           url: `/mini/rest/restView/${restView.rest_code}/edit`,
           data: params,  
           success: function(result) {
               if (result === '1') {
                   alert('ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                   reviewList();  
               } else {
                   alert('ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.');
               }
           },
           error: function(error) {
               console.log(error.responseText);
           }
       });
   });

 // ë¦¬ë·° ì‚­ì œí•˜ê¸°
    $(document).on("click", ".btn-outline-danger", function() {
        if (confirm("ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            var review_no = $(this).data('review-no');
            $.ajax({
               type : 'get',
                url: `/mini/rest/restView/${restView.rest_code}/del`,
                data: { review_no: review_no },
                success: function(result) {
                    if (result === '0') {
                        alert("ì‚­ì œ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
                    } else {
                       alert("ë¦¬ë·°ê°€ ì‚­ì œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        reviewList();
                    }
                },
                error: function(error) {
                    console.log(error.responseText);
                }
            });
        }
    });

    reviewList();
});
</script>
 <!-- ìƒë‹¨ì´ë¯¸ì§€ -->
   <div id="imgBox1">
      <img src="/mini/images/Food/ì•¼ì‹œì¥.jpg" id="imgContent1" />
   </div>
<header class="header">
      <h2>ğŸ“ŒìŒì‹ì  ìƒì„¸ë³´ê¸°</h2>
        <img src="/mini/images/Food/${restView.imageurl}" alt="${restView.store_name} Image" class="header-img"/>
        <h1 class="store-name">${restView.store_name}</h1>
        <span class="status">${isOpen}</span>
    </header>
<!-- ì£¼ì†Œ , ì „í™”ë²ˆí˜¸, ëŒ€í‘œë©”ë‰´, ì¹´í…Œê³ ë¦¬ ì˜ì—­  -->
    <section class="details">
        <div class="detail-item">
            <i class="fa-solid fa-location-arrow"> ì£¼ì†Œ </i>
            <p>${restView.addr}</p>
        </div>
        <div class="detail-item">
            <i class="fa-solid fa-headset"> ë¬¸ì˜ ë° ì•ˆë‚´ </i>
            <p>${restView.tel}</p>
        </div>
        <div class="detail-item">
            <i class="fa-solid fa-utensils"> ëŒ€í‘œë©”ë‰´ </i>
            <p> ${restView.repMenu}</p>
        </div>
        <div class="detail-item">
            <i class="fa-solid fa-list"> ì¹´í…Œê³ ë¦¬ </i>
            <p>${restView.category}</p>
        </div>
      <div class="detail-item">
    <i class="fa-solid fa-thumbs-up like-icon" data-rest-code="${restView.rest_code}"> ì¢‹ì•„ìš” </i>
    <p id="like-count">${updatedLikeCount}</p>
</div>
      <div class="detail-item">
            <i class="fa-solid fa-list"> ë³„ì  </i>
            <p>${averageRating}</p>
        </div>
    </section>

<!-- ì˜ì—…ì‹œê°„  -->
    <section class="hours">
        <h2>ì˜ì—…ì‹œê°„</h2>
        <p>${restView.opentime}</p>
    </section>
<!-- ë©”ë‰´ ë¦¬ìŠ¤íŠ¸  -->
    <section class="menu-list">
        <h2>ë©”ë‰´ ë¦¬ìŠ¤íŠ¸</h2>
        <p>${restView.menu1}</p>
    </section>
<!-- ê°€ê²Œ ì‚¬ì§„ ëª©ë¡  -->
    <section class="photos">
        <h2>${restView.store_name}ì˜ ì‚¬ì§„</h2>
        <div class="photos-gallery">
            <img src="/mini/images/Food/${restView.imageurl1}" alt="Photo 1"/>
            <img src="/mini/images/Food/${restView.imageurl2}" alt="Photo 2"/>
            <img src="/mini/images/Food/${restView.imageurl3}" alt="Photo 3"/>
        </div>
    </section>
<!-- ê°€ê²Œ ìƒì„¸ ë‚´ìš©  -->
    <section class="explanation">
        <h2>ìƒì„¸ ì„¤ëª…</h2>
        <p>${restView.explanation}</p>
    </section>
</div>
<!-- ë¦¬ë·° ì„¹ì…˜ -->
<c:if test="${logStatus == 'Y'}">
    <section class="review-form">
        <h3>ë¦¬ë·° ì‘ì„±í•˜ê¸°</h3>
       <form id="reviewForm" method="post" action="/mini/rest/restView/${restView.rest_code}/ReviewOk">
            <input type="hidden" name="rest_code" value="${restView.rest_code}"/>
            
            <!-- ë¦¬ë·° ë‚´ìš© -->
            <div class="form-group">
                <label for="contents">ë¦¬ë·° ë‚´ìš©:</label>
                <textarea id="contents" name="contents" rows="4" required></textarea>
            </div>
            
            <!-- ë³„ì  ì„ íƒ -->
            <div class="form-group">
                <label for="rating">ë³„ì :</label>
                <div class="rating">
                    <span class="star" data-value="1">â˜…</span>
                    <span class="star" data-value="2">â˜…</span>
                    <span class="star" data-value="3">â˜…</span>
                    <span class="star" data-value="4">â˜…</span>
                    <span class="star" data-value="5">â˜…</span>
                </div>
                <input type="hidden" id="selectedRating" name="rating" value=""/> <!-- ì„ íƒí•œ ë³„ì  ê°’ì„ ì €ì¥ -->
            </div>
            
            <!-- ë¦¬ë·° ì œì¶œ -->
            <input class="review_submit" type="submit" value="ë¦¬ë·°ë“±ë¡"/> <!-- ë²„íŠ¼ì„ submitìœ¼ë¡œ ë³€ê²½ -->
        </form>
    </section>
</c:if>

<section class="reviews">
    <h2>ë¦¬ë·°</h2>
    <div class="reviewList">
        <!-- ë¦¬ë·° ë‚´ìš©ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
    </div>
</section>
<!-- ì§€ë„ ì˜ì—­  -->
 <section class="map">
<h2>ê°€ê²Œ ìœ„ì¹˜</h2>
    <div id="map" style="width:100%;height:700px;"></div>
    <!-- ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° JSONìœ¼ë¡œ ë³€í™˜ -->
    <script type="application/json" id="storeData">
        ${kakaomapJson}
    </script>
<script>
    function loadKakaoMapsScript(callback) {
        const script = document.createElement('script');
        script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=b45e962e5c780aecefa8a8cae0f46328&autoload=false';
        script.onload = callback;
        script.onerror = function() {
            console.error('Failed to load Kakao Maps script.');
        };
        document.head.appendChild(script);
    }

    function initializeMap() {
        kakao.maps.load(function() {
            const jsonString = document.getElementById('storeData').textContent;
            let locations;
            try {
                locations = JSON.parse(jsonString);
                console.log('Parsed JSON data:', locations); // JSON ë°ì´í„° í™•ì¸
            } catch (e) {
                console.error('Failed to parse JSON data:', e);
                return;
            }

            const targetRestCode = locations.length > 0 ? locations[0].rest_code : null;
            const targetLocations = locations.filter(locations => locations.rest_code === targetRestCode);

            if (targetLocations.length === 0) {
                console.error('No store data found for the specified rest_code.');
                return;
            }

            const firstLocation = targetLocations[0];
            const centerPosition = new kakao.maps.LatLng(parseFloat(firstLocation.x_point), parseFloat(firstLocation.y_point));
            
            const mapContainer = document.getElementById('map');
            const mapOptions = {
                center: centerPosition, 
                level: 1,
                disableDefaultUI: true
            };
            const map = new kakao.maps.Map(mapContainer, mapOptions);

            
            // ì§€ë„ ì´ë™ ì œì–´ ë¹„í™œì„±í™”
            map.setDraggable(false); // ë“œë˜ê·¸ë¡œ ì´ë™ ë¶ˆê°€
            map.setZoomable(false); // ì¤Œ ì¡°ì ˆ ë¶ˆê°€

            // ë§ˆì»¤ì™€ ì •ë³´ì°½ ì¶”ê°€
            targetLocations.forEach(locations => {
                const position = new kakao.maps.LatLng(parseFloat(locations.x_point), parseFloat(locations.y_point));
                const marker = new kakao.maps.Marker({
                    position: position,
                    map: map,
                    clickable : true
                });
                
                marker.setMap(map);
                
                const infowindowContent = `<div style="padding:5px; font-size : 0.5em;">`+locations.store_name+`</div>`;
                iwRemoveable = true;                
                
                // InfoWindow ê°ì²´ ìƒì„±
                const infowindow = new kakao.maps.InfoWindow({
                    content: infowindowContent,
                    removable : iwRemoveable
                });
                
                console.log(locations.store_name);
                console.log(locations.addr);
                
                kakao.maps.event.addListener(marker, 'click', function() {
                    infowindow.open(map, marker);
                });
            });
        });
    }

    loadKakaoMapsScript(initializeMap);
    </script>
    </section>
    
  <!-- ê°™ì€ ì¹´í…Œê³ ë¦¬ì˜ ëª©ë¡ ë³´ì—¬ì£¼ê¸° -->
<section class="similarRestaurant">
    <h2>${restView.store_name}ê³¼ ë¹„ìŠ·í•œ ë§›ì§‘</h2>
    <div class="RestaurantSimilar">
        <c:forEach var="restaurant" items="${similarRestaurant}">
            <div class="photo-item">
                <a href="/restaurantDetail?rest_code=${restaurant.rest_code}">
                    <img src="/mini/images/Food/${restaurant.imageurl}" alt="${restaurant.store_name}"/>
                </a>
                <p>${restaurant.store_name}</p>
            </div>
        </c:forEach>
    </div>
</section>

<!-- ë¦¬ë·° ë³´ì—¬ì£¼ëŠ”ê±´ ìœ„ ì•„ë˜ ë‘˜ë‹¤ ë³´ì—¬ì§€ê²Œ  -->
<section class="reviews">
        <h2>ë¦¬ë·°</h2>
        <div class="reviewList">
        </div>
    </section>